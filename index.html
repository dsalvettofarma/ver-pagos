<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Buscador de Pagos</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/1995/1995616.png" type="image/png">
  
  <style>
    * {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      color: #1a1a1a;
      margin: 0;
      padding: 30px;
    }

    h2 {
      font-size: 28px;
      margin-bottom: 15px;
      color: #0052a1;
    }

    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 15px;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.04);
    }

    label {
      font-weight: 600;
      margin-bottom: 5px;
      display: block;
    }

    select, input, button {
      padding: 10px;
      font-size: 14px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    .acciones button {
        width: auto;
    }


    button {
      background-color: #0052a1;
      color: white;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #003f7d;
    }

    #estado {
      font-style: italic;
      color: #555;
      margin-bottom: 10px;
    }
    .mensaje-info{
        font-style: italic;
        color: #555;
        margin-bottom: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      text-align: left;
    }

    th {
        font-weight: 600;
        background-color: #f3faff;
        color: #004080;
    }

    .botonera {
        display: flex;
        flex-direction: column;
        gap: 10px;
        grid-column: span 1;
        align-items: stretch;
        justify-content: center;
    }

    th.col-index, td.col-index {
        border-right: 1px solid rgba(0, 0, 0, 0.1);
        background-color: #f7faff;
        text-align: center;
        width: 40px;
    }

    th, td {
        white-space: nowrap;       /* No dividir texto en varias l√≠neas */
        overflow: hidden;
        text-overflow: ellipsis;   /* Opcional: pone "..." si no entra */
    }

    table {
        table-layout: auto !important;  /* Permite ancho seg√∫n contenido */
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
    }

    .acciones {
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        gap: 12px;
        flex-wrap: wrap;
        background: white;
        padding: 16px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .acciones button {
        padding: 10px 16px;
        font-weight: bold;
        background: #0052a1;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }
    .acciones button:hover {
        background: #003f80;
    }

    .acciones button.button-buscar {
        background: #ffc107;
    }

    .acciones button.button-buscar:hover {
        background: #f5b905;
    }

    .mensaje-acciones {
        text-align: left;
        margin-left: 15px;
        }

    
    @media (max-width: 600px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h2 style="display: flex; align-items: center; gap: 10px;">
    Buscador de Pagos
    <img src="https://cdn-icons-png.flaticon.com/512/1995/1995616.png" alt="√çcono" style="width: 50 px; height: 50px;">
    
  </h2>
  

  <div class="container">
    <div>
      <label>Hoja:</label>
      <select id="sheet" onchange="cargarColumnas()"></select>
    </div>

    <div>
      <label>Columna:</label>
      <select id="column"></select>
    </div>

    <div>
      <label>Valor:</label>
      <input id="value" placeholder="CI, Nombre, Email...">
    </div>
    <div>
        <label>Tipo de b√∫squeda:</label>
        <select id="matchType">
          <option value="contains">Contiene</option>
          <option value="exact">Exacta</option>
        </select>
      </div>
      
    <div>
      <label>Canal de venta:</label>
      <select id="canal">
        <option value="">Todos</option>
        <option value="FARMASHOP">Web</option>
        <option value="FARMASHOP_APP">App</option>
      </select>
    </div>      
  </div>
  <div class="mensaje-acciones">
    <p class="mensaje-info">Record√° precargar la hoja para mejorar tiempos de b√∫squeda y habilitar todas las funciones</p>
  </div>
  <div class="acciones">
    <button onclick="window.open('https://docs.google.com/spreadsheets/d/1SBniJctF3j2nMt4M1IQWFkvjsKhCqJ_h6kqEtcvGdsg/edit', '_blank')">üìÑ Ver hoja</button>
    <button onclick="mostrarUltimo()">üïí √öltimo registro</button>
    <button onclick="analizarAnulados()">üßæ Pagos anulados</button>
    <button onclick="analizarErrores()">üìä Pagos rechazados</button>
    <button id="btnPrecargar" onclick="precargar()" disabled>üîÑ Precargar hoja</button>
    <button class="button-buscar" onclick="buscar()">üîç Buscar</button>
  </div>
  
  <div id="estado"></div>
  <table id="results"></table>

  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbxqiejSj2Y7bLLJBHf6fE_7vfotLDSukaR6evUkbFXoZwufIa1m5p3_Pc0iwpmYYJZZ/exec";
    const prioridad =   ["Id usuario", 
                        "Nombre", 
                        "Email de usuario", 
                        "Fecha", 
                        "Fecha Anulacion/Devolucion", 
                        "Estado", 
                        "Mensaje de respuesta"];

    const ocultar = ["Id (Auth-conf)", 
                    "Propina", 
                    "Ley que aplico", 
                    "Devolucion de impuesto", 
                    "Codigo de autorizacion", 
                    "Moneda", 
                    "Ticket", 
                    "Numero de de comercio", 
                    "Numero de terminal", 
                    "Ref. enviada al autorizador", 
                    "Ref. devuelta por el autorizador", 
                    "Proceso Aut."];
  
    let cachedData = null;
    let cachedHeaders = null;
  
    function ajustarYFormatear(fechaIso) {
      const fecha = new Date(fechaIso);
      if (isNaN(fecha)) return fechaIso;
      fecha.setHours(fecha.getHours() - 4); // Ajuste UTC-3
      const yyyy = fecha.getFullYear();
      const mm = String(fecha.getMonth() + 1).padStart(2, "0");
      const dd = String(fecha.getDate()).padStart(2, "0");
      const hh = String(fecha.getHours()).padStart(2, "0");
      const min = String(fecha.getMinutes()).padStart(2, "0");
      const ss = String(fecha.getSeconds()).padStart(2, "0");
      return `${dd}/${mm}/${yyyy} ${hh}:${min}:${ss}`;
    }
  
    function addScript(src) {
      document.querySelectorAll("script[data-temp]").forEach(s => s.remove());
      const script = document.createElement("script");
      script.src = src;
      script.setAttribute("data-temp", "true");
      document.body.appendChild(script);
    }
  
    function ordenarHeaders(headers) {
      const visibles = headers.filter(h => !ocultar.includes(h));
      const principales = prioridad.filter(h => visibles.includes(h));
      const otros = visibles.filter(h => !principales.includes(h));
      return [...principales, ...otros];
    }
  
    function cargarHojas() {
        window.handleSheets = function (data) {
  const sel = document.getElementById("sheet");
  sel.innerHTML = "";

  data.sheets.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  });

  // ‚úÖ Seleccionar autom√°ticamente la primera hoja y precargar
    const hojaPrimera = data.sheets[0];
    sel.value = hojaPrimera;
    cargarColumnas(); 
     precargar();

  // ‚úÖ Activar bot√≥n luego de cargar hojas
  document.getElementById("btnPrecargar").disabled = false;
};


  // üîí Desactivar bot√≥n mientras carga
  document.getElementById("btnPrecargar").disabled = true;
  addScript(`${endpoint}?action=getSheets&callback=handleSheets`);
}

  
    function cargarColumnas() {
        const hoja = document.getElementById("sheet").value;
        window.handleHeaders = function (data) {
            const sel = document.getElementById("column");
            sel.innerHTML = "";

            // üîç Agregamos "Buscar en todo" al inicio
            const optAll = document.createElement("option");
            optAll.value = "__all__";
            optAll.textContent = "üîç Buscar en todo";
            sel.appendChild(optAll);

            // Luego el resto de las columnas
            const headers = ordenarHeaders(data.headers);
            headers.forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            sel.appendChild(opt);
            });

            // ‚úÖ Opcional: dejar seleccionada por defecto
            sel.value = "__all__";
        };

        addScript(`${endpoint}?action=getHeaders&sheet=${encodeURIComponent(hoja)}&callback=handleHeaders`);
    }

  
    function precargar() {
      const hoja = document.getElementById("sheet").value;
      const estado = document.getElementById("estado");
      let start = Date.now();
      let timer = setInterval(() => {
        const elapsed = ((Date.now() - start) / 1000).toFixed(1);
        estado.innerText = `‚è≥ Precargando datos... ${elapsed}s`;
      }, 200);
  
      window.handlePrecache = function (data) {
        clearInterval(timer);
        const elapsed = ((Date.now() - start) / 1000).toFixed(1);
        if (data.error) {
          cachedData = null;
          estado.innerText = `‚ùå Error: ${data.error}`;
          return;
        }
        cachedHeaders = data.headers;
        cachedData = data.results;
        estado.innerText = `‚úÖ Hoja precargada en ${elapsed}s ‚Ä¢ ${cachedData.length} registros`;
      };
      addScript(`${endpoint}?action=search&sheet=${encodeURIComponent(hoja)}&column=todos&value=__all__&callback=handlePrecache`);
    }
  
    function buscar() {
  const estado = document.getElementById("estado");
  const table = document.getElementById("results");

  // üí° VERIFICAMOS SI EST√Å PRECARGADO
  if (!cachedData || !cachedHeaders) {
    estado.innerText = "‚ö†Ô∏è Precarg√° primero una hoja para usar esta opci√≥n.";
    table.innerHTML = ""; // Limpiamos resultados previos si los hubiera
    return;
  }

  const hoja = document.getElementById("sheet").value;
  const columna = document.getElementById("column").value;
  const valor = document.getElementById("value").value;
  const canal = document.getElementById("canal").value;
  const matchType = document.getElementById("matchType").value;

  // ‚ö†Ô∏è Validaci√≥n de campo vac√≠o
  if (!valor.trim()) {
    estado.innerText = "‚ö†Ô∏è Ingres√° un valor para buscar.";
    return;
  }

  let start = Date.now();
  let timer = setInterval(() => {
    const elapsed = ((Date.now() - start) / 1000).toFixed(1);
    estado.innerText = `‚è≥ Buscando... ${elapsed}s`;
  }, 200);

  const mostrarResultados = (data) => {
  clearInterval(timer);
  const elapsed = ((Date.now() - start) / 1000).toFixed(1);

  const headersOrdenados = ordenarHeaders(data.headers);
  const idxs = headersOrdenados.map(h => data.headers.indexOf(h));
  const comercioIdx = data.headers.indexOf("Comercio");
  const busqueda = valor.toLowerCase();

let resultadosFiltrados = [];

if (columna === "__all__") {
  resultadosFiltrados = data.results.filter(row => {
    const coincide = row.some(celda => (celda || "").toString().toLowerCase().includes(busqueda));
    const comercioVal = (row[comercioIdx] || "").trim();
    const canalCoincide = canal ? comercioVal === canal : true;
    return coincide && canalCoincide;
  });
} else {
  const colIdx = data.headers.indexOf(columna);
  resultadosFiltrados = data.results.filter(row => {
    const celda = (row[colIdx] || "").toString().toLowerCase();
    const coincide = matchType === "exact" ? celda === busqueda : celda.includes(busqueda);
    const comercioVal = (row[comercioIdx] || "").trim();
    const canalCoincide = canal ? comercioVal === canal : true;
    return coincide && canalCoincide;
  });
}


  const total = resultadosFiltrados.length;
  estado.innerText = `‚úÖ Resultado en ${elapsed}s ‚Ä¢ ${total} resultado${total !== 1 ? "s" : ""}`;

  // Si no hay resultados, salir sin renderizar tabla
  if (total === 0) {
    table.innerHTML = "";
    return;
  }

  table.innerHTML = "";


  // Crear <thead> con <tr>
  const thead = document.createElement("thead");
  thead.className = "draggable-header";
  const headerRow = document.createElement("tr");

  // Crear <tbody> para los datos
  const tbody = document.createElement("tbody");

  const thIndex = document.createElement("th");
  thIndex.textContent = "#";
  thIndex.className = "col-index";
  headerRow.appendChild(thIndex);

  headersOrdenados.forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    headerRow.appendChild(th);
  });

  thead.appendChild(headerRow);
  table.appendChild(thead);
  table.appendChild(tbody);

  resultadosFiltrados.forEach((row, i) => {
    const tr = document.createElement("tr");
    const tdIndex = document.createElement("td");
    tdIndex.textContent = i + 1;
    tdIndex.className = "col-index";
    tr.appendChild(tdIndex);

    idxs.forEach(j => {
      const td = document.createElement("td");
      let valor = row[j] || "";
      if (typeof valor === "string" && /^\d{4}-\d{2}-\d{2}T/.test(valor)) {
        valor = ajustarYFormatear(valor);
      }
      td.textContent = valor;

      if (cachedHeaders[j] === "Estado") {
  const estadoTexto = valor.toLowerCase();
  if (estadoTexto === "rechazado") {
    td.style.color = "#a94442";
    td.style.fontWeight = "bold";
  } else if (estadoTexto === "autorizado") {
    td.style.color = "#2e7d32";
    td.style.fontWeight = "bold";
  } else if (estadoTexto === "anulado") {
    td.style.color = "#b36b00"; // o "#555555"
    td.style.fontWeight = "bold";
  }
}


      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  
};


  mostrarResultados({ headers: cachedHeaders, results: cachedData });
}


  
    function mostrarUltimo() {
      const estado = document.getElementById("estado");
      const table = document.getElementById("results");
  
      if (!cachedData || !cachedHeaders) {
        estado.innerText = "‚ö†Ô∏è Precarg√° primero una hoja para usar esta opci√≥n.";
        return;
      }
  
      const fechaIdx = cachedHeaders.findIndex(h => h.toLowerCase().includes("fecha") && !h.toLowerCase().includes("anulacion"));
      if (fechaIdx === -1) {
        estado.innerText = "‚ùå No se encontr√≥ columna de fecha v√°lida.";
        return;
      }
  
      const filasConFechas = cachedData
        .map(row => {
          const raw = row[fechaIdx];
          const fecha = new Date(raw);
          return isNaN(fecha) ? null : { row, fecha };
        })
        .filter(Boolean);
  
      if (filasConFechas.length === 0) {
        estado.innerText = "‚ö†Ô∏è No se encontraron fechas v√°lidas.";
        return;
      }
  
      const { row: ultima, fecha } = filasConFechas.sort((a, b) => b.fecha - a.fecha)[0];
      estado.innerText = `üïí √öltimo pago registrado: ${ajustarYFormatear(fecha)}`;
  
      const headersOrdenados = ordenarHeaders(cachedHeaders);
      const idxs = headersOrdenados.map(h => cachedHeaders.indexOf(h));
      table.innerHTML = "";
  
      const headerRow = document.createElement("tr");
      const thIndex = document.createElement("th");
      thIndex.textContent = "#";
      thIndex.className = "col-index";
      headerRow.appendChild(thIndex);
  
      headersOrdenados.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);
  
      const tr = document.createElement("tr");
      const tdIndex = document.createElement("td");
      tdIndex.textContent = "1";
      tdIndex.className = "col-index";
      tr.appendChild(tdIndex);
  
      idxs.forEach(j => {
        const td = document.createElement("td");
        let valor = ultima[j] || "";
        if (typeof valor === "string" && /^\d{4}-\d{2}-\d{2}T/.test(valor)) {
          valor = ajustarYFormatear(valor);
        }
        td.textContent = valor;
        tr.appendChild(td);
      });
      table.appendChild(tr);
    }

    function analizarErrores() {
        if (!cachedData || !cachedHeaders) {
        document.getElementById("estado").innerText = "‚ö†Ô∏è Precarg√° primero una hoja para usar esta opci√≥n.";
        return;
        }


    const estado = document.getElementById("estado");
    const table = document.getElementById("results");
    const estadoIdx = cachedHeaders.indexOf("Estado");
    const mensajeIdx = cachedHeaders.indexOf("Mensaje de respuesta");
    const canalIdx = cachedHeaders.indexOf("Comercio");
    const autorizadorIdx = cachedHeaders.indexOf("Autorizador");

    const errores = cachedData.filter(row => (row[estadoIdx] || "").toLowerCase() === "rechazado");

    const resumen = {};
    errores.forEach(row => {
      const msg = row[mensajeIdx] || "(sin mensaje)";
      const canal = row[canalIdx] || "(desconocido)";
      const autorizador = row[autorizadorIdx] || "(sin autorizador)";
      const clave = msg;
      if (!resumen[clave]) resumen[clave] = {};
      if (!resumen[clave][autorizador]) resumen[clave][autorizador] = { total: 0, web: 0, app: 0 };
      resumen[clave][autorizador].total++;
      if (canal.includes("APP")) resumen[clave][autorizador].app++;
      else resumen[clave][autorizador].web++;
    });

    let resumenHTML = `<table style="max-width:700px"><tr><th class='col-index'>#</th><th>Mensaje</th><th>Autorizador</th><th>Total</th><th>Web</th><th>App</th></tr>`;
    let index = 1;
    Object.entries(resumen)
      .flatMap(([msg, auts]) => Object.entries(auts).map(([aut, r]) => ({ msg, aut, ...r })))
      .sort((a, b) => b.total - a.total)
      .forEach((entry, i) => {
        resumenHTML += `<tr><td class='col-index'>${i + 1}</td><td>${entry.msg}</td><td>${entry.aut}</td><td>${entry.total}</td><td>${entry.web}</td><td>${entry.app}</td></tr>`;
      });
    
    resumenHTML += `</table>`;

    table.innerHTML = resumenHTML;
    estado.innerText = `üìä Rechazos encontrados: ${errores.length}`;
  }
   

  function analizarAnulados() {
    if (!cachedData || !cachedHeaders) {
    document.getElementById("estado").innerText = "‚ö†Ô∏è Precarg√° primero una hoja para usar esta opci√≥n.";
    return;
    }


    const estado = document.getElementById("estado");
    const table = document.getElementById("results");
    const estadoIdx = cachedHeaders.indexOf("Estado");
    const canalIdx = cachedHeaders.indexOf("Comercio");

    const anulados = cachedData.filter(row => (row[estadoIdx] || "").toLowerCase() === "anulado");

    const resumen = {};
    anulados.forEach(row => {
      const canal = row[canalIdx] || "(desconocido)";
      if (!resumen[canal]) resumen[canal] = 0;
      resumen[canal]++;
    });

    let resumenHTML = `<table style="max-width:400px"><tr><th class='col-index'>#</th><th>Canal</th><th>Total</th></tr>`;
    Object.entries(resumen).sort((a, b) => b[1] - a[1]).forEach(([canal, total], i) => {
      resumenHTML += `<tr><td class='col-index'>${i + 1}</td><td>${canal}</td><td>${total}</td></tr>`;
    });
    resumenHTML += `</table>`;

    table.innerHTML = resumenHTML;
    estado.innerText = `üìë Anulados encontrados: ${anulados.length}`;
  }
  document.getElementById("value").addEventListener("keydown", function(event) {
  if (event.key === "Enter") {
    event.preventDefault(); // Evita el comportamiento por defecto del Enter
    buscar(); // Llama a la funci√≥n de b√∫squeda
  }
});

    cargarHojas();
  </script>
  
</body>
</html>
