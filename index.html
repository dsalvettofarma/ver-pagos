<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Buscador de Pagos</title>
  <style>
    * {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      color: #1a1a1a;
      margin: 0;
      padding: 30px;
    }

    h2 {
      font-size: 28px;
      margin-bottom: 20px;
      color: #0052a1;
    }

    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.04);
    }

    label {
      font-weight: 600;
      margin-bottom: 5px;
      display: block;
    }

    select, input, button {
      padding: 10px;
      font-size: 14px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }

    button {
      background-color: #0052a1;
      color: white;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #003f7d;
    }

    #estado {
      font-style: italic;
      color: #555;
      margin-bottom: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      text-align: left;
    }

    th {
        background-color: #dbeeff;
        color: #003f7d;
        font-weight: 600;
    }

    .botonera {
        display: flex;
        flex-direction: column;
        gap: 10px;
        grid-column: span 1;
        align-items: stretch;
        justify-content: center;
    }

    th.col-index, td.col-index {
        border-right: 1px solid rgba(0, 0, 0, 0.1);
        background-color: #f7faff;
        text-align: center;
        width: 40px;
    }

    @media (max-width: 600px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h2>Buscador de Pagos</h2>

  <div class="container">
    <div>
      <label>Hoja:</label>
      <select id="sheet" onchange="cargarColumnas()"></select>
    </div>

    <div>
      <label>Columna:</label>
      <select id="column"></select>
    </div>

    <div>
      <label>Valor:</label>
      <input id="value" placeholder="CI, Nombre, Email...">
    </div>
    <div>
        <label>Tipo de bÃºsqueda:</label>
        <select id="matchType">
          <option value="contains">Contiene</option>
          <option value="exact">Exacta</option>
        </select>
      </div>
      
    <div>
      <label>Canal de venta:</label>
      <select id="canal">
        <option value="">Todos</option>
        <option value="FARMASHOP">Web</option>
        <option value="FARMASHOP_APP">App</option>
      </select>
    </div>

    <div class="botonera">
        <button onclick="buscar()">ðŸ”Ž Buscar</button>
        <button onclick="precargar()">âš¡ Precargar hoja</button>
      </div>
      
      
  </div>

  <div id="estado"></div>
  <table id="results"></table>

  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbxqiejSj2Y7bLLJBHf6fE_7vfotLDSukaR6evUkbFXoZwufIa1m5p3_Pc0iwpmYYJZZ/exec";
    const prioridad = ["Id usuario", "Nombre", "Email de usuario"];
  
    let cachedData = null;
    let cachedHeaders = null;
  
    function addScript(src) {
      document.querySelectorAll("script[data-temp]").forEach(s => s.remove());
      const script = document.createElement("script");
      script.src = src;
      script.setAttribute("data-temp", "true");
      document.body.appendChild(script);
    }
  
    function ordenarHeaders(headers) {
      const principales = prioridad.filter(h => headers.includes(h));
      const otros = headers.filter(h => !principales.includes(h));
      return [...principales, ...otros];
    }
  
    function cargarHojas() {
      window.handleSheets = function (data) {
        const sel = document.getElementById("sheet");
        sel.innerHTML = "";
        data.sheets.forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        });
        cargarColumnas();
      };
      addScript(`${endpoint}?action=getSheets&callback=handleSheets`);
    }
  
    function cargarColumnas() {
      const hoja = document.getElementById("sheet").value;
      window.handleHeaders = function (data) {
        const sel = document.getElementById("column");
        sel.innerHTML = "";
        const headers = ordenarHeaders(data.headers);
        headers.forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        });
      };
      addScript(`${endpoint}?action=getHeaders&sheet=${encodeURIComponent(hoja)}&callback=handleHeaders`);
    }
  
    function precargar() {
      const hoja = document.getElementById("sheet").value;
      const estado = document.getElementById("estado");
  
      let start = Date.now();
      estado.innerText = "â³ Precargando datos...";
  
      window.handlePrecache = function (data) {
        const elapsed = ((Date.now() - start) / 1000).toFixed(1);
        if (data.error) {
          cachedData = null;
          estado.innerText = `âŒ Error: ${data.error}`;
          return;
        }
  
        cachedHeaders = data.headers;
        cachedData = data.results;
        estado.innerText = `âœ… Hoja precargada en ${elapsed}s â€¢ ${cachedData.length} registros`;
      };
  
      addScript(`${endpoint}?action=search&sheet=${encodeURIComponent(hoja)}&column=todos&value=__all__&callback=handlePrecache`);
    }
  
    function buscar() {
      const hoja = document.getElementById("sheet").value;
      const columna = document.getElementById("column").value;
      const valor = document.getElementById("value").value;
      const canal = document.getElementById("canal").value;
      const matchType = document.getElementById("matchType").value;
      const estado = document.getElementById("estado");
      const table = document.getElementById("results");
  
      let start = Date.now();
      let timer = setInterval(() => {
        const elapsed = ((Date.now() - start) / 1000).toFixed(1);
        estado.innerText = `â³ Buscando... ${elapsed}s`;
      }, 200);
  
      const mostrarResultados = (data) => {
        clearInterval(timer);
        const elapsed = ((Date.now() - start) / 1000).toFixed(1);
  
        const headersOrdenados = ordenarHeaders(data.headers);
        const idxs = headersOrdenados.map(h => data.headers.indexOf(h));
        const comercioIdx = data.headers.indexOf("Comercio");
        const colIdx = data.headers.indexOf(columna);
        const busqueda = valor.toLowerCase();
  
        const resultadosFiltrados = data.results.filter(row => {
          const celda = (row[colIdx] || "").toString().toLowerCase();
          const coincide = matchType === "exact" ? celda === busqueda : celda.includes(busqueda);
          const comercioVal = (row[comercioIdx] || "").trim();
          const canalCoincide = canal ? comercioVal === canal : true;
          return coincide && canalCoincide;
        });
  
        const total = resultadosFiltrados.length;
        estado.innerText = `âœ… Resultado en ${elapsed}s â€¢ ${total} resultado${total !== 1 ? "s" : ""}`;
  
        table.innerHTML = "";
        const headerRow = document.createElement("tr");
        const thIndex = document.createElement("th");
        thIndex.textContent = "#";
        thIndex.className = "col-index";
        headerRow.appendChild(thIndex);

  
        headersOrdenados.forEach(h => {
          const th = document.createElement("th");
          th.textContent = h;
          headerRow.appendChild(th);
        });
        table.appendChild(headerRow);
  
        resultadosFiltrados.forEach((row, i) => {
          const tr = document.createElement("tr");
          const tdIndex = document.createElement("td");
            tdIndex.textContent = i + 1;
            tdIndex.className = "col-index";
            tr.appendChild(tdIndex);

          idxs.forEach(j => {
            const td = document.createElement("td");
            td.textContent = row[j] || "";
            tr.appendChild(td);
          });
          table.appendChild(tr);
        });
      };
  
      if (cachedData && cachedHeaders) {
        mostrarResultados({
          headers: cachedHeaders,
          results: cachedData
        });
        return;
      }
  
      window.handleSearch = mostrarResultados;
  
      addScript(`${endpoint}?action=search&sheet=${encodeURIComponent(hoja)}&column=${encodeURIComponent(columna)}&value=${encodeURIComponent(valor)}&matchType=${matchType}&callback=handleSearch`);
    }
  
    cargarHojas();
  </script>
  
</body>
</html>
